# **TECHNICAL SPECIFICATION: MARKET PULSE → SENTINEL BRIDGE**

## **1.0 SYSTEM CONTEXT**

* **Role:** The Market Pulse database acts as the staging area.  
* **Ingest:** Fetch raw reservation data from the **Cloudbeds API** (`getReservations`).  
* **Export:** Generate a strictly formatted `.csv` file for the Sentinel AI Training Hub.  
* **Critical Requirement:** The exported CSV must match the legacy **Cloudbeds CSV Report Schema** exactly, or the AI pipeline will fail.

---

## **2.0 THE "GOLDEN SCHEMA" (TARGET EXPORT FORMAT)**

The CSV generated by Market Pulse **must** contain these exact headers in this order.

| CSV Header (Exact Name) | Data Type | Description / Logic |
| :---- | :---- | :---- |
| **`id`** | String | The unique Reservation ID. |
| **`hotelId`** | String | Unique Property ID. |
| **`reservationDateCreated`** | DateTime | Format: `YYYY-MM-DD HH:MM:SS`. Used for Lead Time calc. |
| **`status`** | String | Must be lowercase: `confirmed`, `canceled`, or `checked_out`. |
| **`checkInDate`** | Date | Format: `YYYY-MM-DD`. |
| **`checkOutDate`** | Date | Format: `YYYY-MM-DD`. |
| **`adults`** | Integer | **MANDATORY.** See Section 4.1 for Injection Rules. |
| **`children`** | Integer | Default to `0` if unknown. |
| **`totalRate`** | Decimal | Total revenue for the booking (Room \+ Add-ons). |
| **`detailedRoomRates`** | JSON String | **COMPLEX.** Daily rate breakdown. See Section 4.2. |
| **`sourceName`** | String | Channel Name (e.g., "Booking.com", "Expedia"). |
| **`roomTypeId`** | String | Internal ID for the room category. |
| **`guestCountry`** | String | 2-letter ISO code (e.g., "US", "GB"). Can be empty. |

Export to Sheets  
---

## **3.0 CLOUDBEDS API MAPPING**

When fetching from Cloudbeds API (`/getReservations`), map the JSON response fields to the Target CSV Headers as follows:

| Cloudbeds API Field (Source) | → | Target CSV Header | Notes |
| :---- | :---- | :---- | :---- |
| `reservationID` | → | `id` | Primary Key. |
| `propertyID` | → | `hotelId` |  |
| `dateCreated` | → | `reservationDateCreated` | Ensure ISO format is converted to `YYYY-MM-DD HH:MM:SS`. |
| `status` | → | `status` | Normalize to lowercase. |
| `startDate` | → | `checkInDate` |  |
| `endDate` | → | `checkOutDate` |  |
| `adults` | → | `adults` | **CRITICAL:** If API returns `null` or 0, see Sec 4.1. |
| `total` | → | `totalRate` | Use the gross total. |
| `source` | → | `sourceName` |  |
| `rooms` (Array) | → | `detailedRoomRates` | Requires transformation (See 4.2). |

Export to Sheets  
---

## **4.0 CRITICAL DATA TRANSFORMATIONS**

### **4.1 The "Adults" Injection Rule**

The Sentinel AI strictly filters for **2 Adults** (Double Occupancy) to determine "Pure Demand."

* **Issue:** Some API endpoints or historical imports might miss the `adults` count.  
* **Rule:** If the `adults` count is missing in the source data, **hardcode the value `2`** in the CSV export.  
* *Warning:* Do not leave this field blank. The row will be rejected.

### **4.2 The "Detailed Room Rates" JSON Parser**

This is the most common point of failure. The Sentinel AI expects a **Date-Keyed Dictionary**, not a List of Objects.

* **Wrong Format (Do Not Use):** `[{"date": "2025-12-01", "rate": 100}, {"date": "2025-12-02", "rate": 100}]`  
* **Correct Format (Required):** `{"2025-12-01": 100, "2025-12-02": 100}`

**Logic for Developer:**

1. Iterate through the daily rates array from the API.  
2. Extract the `date` and the `daily_rate`.  
3. Construct a single JSON object where keys are dates and values are floats.  
4. Store/Export this object as a string in the CSV column `detailedRoomRates`.

---

## **5.0 FINAL EXPORT CHECKLIST**

Before generating the file for the AI, the system must verify:

1. **Date Filter:** Only export bookings created **on or after Jan 1, 2024** (The Modern Era Rule).  
2. **Column Names:** Are headers exactly `detailedRoomRates`, `reservationDateCreated` (camelCase)?  
3. **JSON Validity:** Is the `detailedRoomRates` column valid JSON, or is it double-escaped strings? (Must be valid JSON string).  
4. **Adults:** Are there any `null` values in the `adults` column? (If yes, fix before export).

